import{_ as s,c as n,o as a,a as l}from"./app.89d965e1.js";const e="/blog/assets/buffer_01.8a0198ff.png",f=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[{"level":2,"title":"Buffer 探究","slug":"buffer-探究","link":"#buffer-探究","children":[]},{"level":2,"title":"什么是二进制","slug":"什么是二进制","link":"#什么是二进制","children":[]},{"level":2,"title":"node 中为什么会出现 Buffer 这个模块","slug":"node-中为什么会出现-buffer-这个模块","link":"#node-中为什么会出现-buffer-这个模块","children":[]},{"level":2,"title":"Buffer 创建","slug":"buffer-创建","link":"#buffer-创建","children":[]},{"level":2,"title":"Buffer 的内存分配机制","slug":"buffer-的内存分配机制","link":"#buffer-的内存分配机制","children":[]},{"level":2,"title":"Buffer 与 stream","slug":"buffer-与-stream","link":"#buffer-与-stream","children":[]}],"relativePath":"node/buffer.md"}'),p={name:"node/buffer.md"},o=l(`<p><strong>前言</strong></p><p>写完上一篇文章<a href="./stream.html">想学 Node.js，stream 先有必要搞清楚</a> 留下了悬念，<code>stream</code>对象数据流转的具体内容是什么？本篇文章将为大家进行深入讲解。</p><h2 id="buffer-探究" tabindex="-1">Buffer 探究 <a class="header-anchor" href="#buffer-探究" aria-hidden="true">#</a></h2><p>看一段之前使用<code>stream</code>操作文件的例子：</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> fileName </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#A6ACCD;">(__dirname</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">data.txt</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> stream </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createReadStream</span><span style="color:#A6ACCD;">(fileName)</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">stream内容</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> stream)</span></span>
<span class="line"><span style="color:#A6ACCD;">stream</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">data</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">chunk</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">chunk</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">instanceof</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Buffer</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">chunk</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>看一下打印结果，发现第一个 stream 是一个对象 ，部分内容。</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki"><code><span class="line"><span style="color:#FFCB6B;">_readableState</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> ReadableState </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">objectMode</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">highWaterMark</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">16384</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">buffer</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">BufferList</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">head</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">tail</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">length</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">length</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">pipes</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">pipesCount</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">flowing</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">ended</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">endEmitted</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">reading</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">sync</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">needReadable</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">emittedReadable</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">readableListening</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">resumeScheduled</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">emitClose</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">autoDestroy</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">destroyed</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">defaultEncoding</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">utf8</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">awaitDrainWriters</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">multiAwaitDrain</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">readingMore</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">decoder</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">encoding</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>第二个和第三个打印结果，</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">&lt;Buffer e5 86 99 e5 85 a5 e6 88 90 e5 8a 9f ef bc 9a 6d 6a 31 32 33 34 35 36 e5 86 99 e5 85 a5 e5 86 99 e5 85 a5&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Buffer 对象，类似数组，它的元素为 16 进制的两位数，即 0 到 255 的数值。可以看出 stream 中流动的数据是 Buffer 类型，二进制数据，接下来开始我们的 Buffer 探索之旅。</p><h2 id="什么是二进制" tabindex="-1">什么是二进制 <a class="header-anchor" href="#什么是二进制" aria-hidden="true">#</a></h2><p>二进制是计算机最底层的数据格式，字符串，数字，视频，音频，程序，网络包等，在最底层都是用二进制来进行存储。这些高级格式和二进制之间，都可以通过固定的编码格式进行相互转换。</p><p>例如，C 语言中 int32 类型的十进制整数（无符号），就占用 32bit 即 4byte，十进制的 3 对应的二进制就是<code>00000000 00000000 00000000 00000011</code>。字符串也是同理，可以根据 ASCII 编码规则或者 unicode 编码规则（如 utf-8）等和二进制进行相互转换。总之，计算机底层存储的数据都是二进制格式，各种高级类型都有对应的编码规则和二进制进行相互转换。</p><h2 id="node-中为什么会出现-buffer-这个模块" tabindex="-1">node 中为什么会出现 Buffer 这个模块 <a class="header-anchor" href="#node-中为什么会出现-buffer-这个模块" aria-hidden="true">#</a></h2><p>在最初的<code>javascript</code>生态中，<code>javascript</code>还运行在浏览器端，对于处理 Unicode 编码的字符串数据很容易，但是对于处理二进制以及非<code>Unicode</code>编码的数据无能为力，但是对于<code>Server</code>端操作<code>TCP/HTTP</code>以及<code>文件I/O</code>的处理是必须的。我想就是因此在<code>Node.js</code>里面提供了<code>Buffer</code>类处理二进制的数据，可以处理各种类型的数据。</p><p>Buffer 模块的一个说明。</p><blockquote><p>在 Node.js 里面一些重要模块 net、http、fs 中的数据传输以及处理都有 Buffer 的身影，因为一些基础的核心模块都要依赖 Buffer，所以在 node 启动的时候，就已经加载了 Buffer，我们可以在全局下面直接使用 Buffer，无需通过 require()。且 Buffer 的大小在创建时确定，无法调整。</p></blockquote><h2 id="buffer-创建" tabindex="-1">Buffer 创建 <a class="header-anchor" href="#buffer-创建" aria-hidden="true">#</a></h2><p>在 <code>NodeJS v6.0.0</code>版本之前，<code>Buffer</code>实例是通过 Buffer 构造函数创建的，即使用 new 关键字创建，它根据提供的参数返回不同的 Buffer，但在之后的版本中这种声明方式就被废弃了，替代 new 的创建方式主要有以下几种。</p><h4 id="_1-buffer-alloc-和-buffer-allocunsafe-创建固定大小的-buffer" tabindex="-1">1. Buffer.alloc 和 Buffer.allocUnsafe(创建固定大小的 buffer) <a class="header-anchor" href="#_1-buffer-alloc-和-buffer-allocunsafe-创建固定大小的-buffer" aria-hidden="true">#</a></h4><p>用 <code>Buffer.alloc</code> 和 <code>Buffer.allocUnsafe</code> 创建 Buffer 的传参方式相同，参数为创建 Buffer 的长度，数值类型。</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// Buffer.alloc 和 Buffer.allocUnsafe 创建 Buffer</span></span>
<span class="line"><span style="color:#676E95;">// Buffer.alloc 创建 Buffer,创建一个大小为6字节的空buffer，经过了初始化</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> buf1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Buffer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">alloc</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">6</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// Buffer.allocUnsafe 创建 Buffer，创建一个大小为6字节的buffer，未经过初始化</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> buf2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Buffer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">allocUnsafe</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">6</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf1) </span><span style="color:#676E95;">// &lt;Buffer 00 00 00 00 00 00&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf2) </span><span style="color:#676E95;">// &lt;Buffer 78 ab 13 4f 60 02&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>通过代码可以看出，用 <code>Buffer.alloc</code> 和 <code>Buffer.allocUnsafe</code> 创建<code>Buffer</code> 是有区别的，<code>Buffer.alloc</code> 创建的 <code>Buffer</code> 是被初始化过的，即 <code>Buffer</code> 的每一项都用 00 填充，而 <code>Buffer.allocUnsafe</code> 创建的 Buffer 并没有经过初始化，在内存中只要有闲置的 Buffer 就直接 “抓过来” 使用。</p><p><code>Buffer.allocUnsafe</code> 创建 <code>Buffer</code> 使得内存的分配非常快，但已分配的内存段可能包含潜在的敏感数据，有明显性能优势的同时又是不安全的，所以使用需格外 “小心”。</p><h4 id="_2、buffer-from-根据内容直接创建-buffer" tabindex="-1">2、Buffer.from(根据内容直接创建 Buffer) <a class="header-anchor" href="#_2、buffer-from-根据内容直接创建-buffer" aria-hidden="true">#</a></h4><blockquote><p>Buffer.from(str, ) 支持三种传参方式：</p></blockquote><ul><li>第一个参数为字符串，第二个参数为字符编码，如 <code>ASCII</code>、<code>UTF-8</code>、<code>Base64</code> 等等。</li><li>传入一个数组，数组的每一项会以十六进制存储为 <code>Buffer</code> 的每一项。</li><li>传入一个<code>Buffer</code>，会将 <code>Buffer</code> 的每一项作为新返回 <code>Buffer</code> 的每一项。</li></ul><p><strong>说明:<code>Buffer</code>目前支持的编码格式</strong></p><ul><li>ascii - 仅支持 7 位 ASCII 数据。</li><li>utf8 - 多字节编码的 Unicode 字符</li><li>utf16le - 2 或 4 个字节，小端编码的 Unicode 字符</li><li>base64 - Base64 字符串编码</li><li>binary - 二进制编码。</li><li>hex - 将每个字节编码为两个十六进制字符。</li></ul><h5 id="传入字符串和字符编码" tabindex="-1">传入字符串和字符编码： <a class="header-anchor" href="#传入字符串和字符编码" aria-hidden="true">#</a></h5><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// 传入字符串和字符编码</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> buf </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Buffer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">from</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">hello</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">utf8</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf) </span><span style="color:#676E95;">// &lt;Buffer 68 65 6c 6c 6f&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="传入数组" tabindex="-1">传入数组： <a class="header-anchor" href="#传入数组" aria-hidden="true">#</a></h5><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// 数组成员为十进制数</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> buf </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Buffer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">from</span><span style="color:#A6ACCD;">([</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf) </span><span style="color:#676E95;">// &lt;Buffer 01 02 03&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// 数组成员为十六进制数</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> buf </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Buffer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">from</span><span style="color:#A6ACCD;">([</span><span style="color:#F78C6C;">0xe4</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0xbd</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0xa0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0xe5</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0xa5</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0xbd</span><span style="color:#A6ACCD;">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf) </span><span style="color:#676E95;">// &lt;Buffer e4 bd a0 e5 a5 bd&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">utf8</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)) </span><span style="color:#676E95;">// 你好</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在 <code>NodeJS</code> 中不支持 <code>GB2312</code> 编码，默认支持 <code>UTF-8</code>，在 <code>GB2312</code> 中，一个汉字占两个字节，而在 <code>UTF-8</code> 中，<code>一个汉字</code>占三个字节，所以上面 “你好” 的 <code>Buffer</code> 为 6 个十六进制数组成。</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// 数组成员为字符串类型的数字</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> buf </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Buffer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">from</span><span style="color:#A6ACCD;">([</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">3</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf) </span><span style="color:#676E95;">// &lt;Buffer 01 02 03&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>传入的数组成员可以是任何进制的数值，当成员为字符串的时候，如果值是数字会被自动识别成数值类型，如果值不是数字或成员为是其他非数值类型的数据，该成员会被初始化为 00。</p><p>创建的 <code>Buffer</code> 可以通过 <code>toString</code> 方法直接指定编码进行转换，默认编码为 <code>UTF-8</code>。</p><h5 id="传入-buffer" tabindex="-1">传入 Buffer： <a class="header-anchor" href="#传入-buffer" aria-hidden="true">#</a></h5><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// 传入一个 Buffer</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> buf1 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Buffer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">from</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">hello</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">utf8</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> buf2 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Buffer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">from</span><span style="color:#A6ACCD;">(buf1)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf1) </span><span style="color:#676E95;">// &lt;Buffer 68 65 6c 6c 6f&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf2) </span><span style="color:#676E95;">// &lt;Buffer 68 65 6c 6c 6f&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf1 </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> buf2) </span><span style="color:#676E95;">// false</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf1[</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">] </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> buf2[</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">]) </span><span style="color:#676E95;">// true</span></span>
<span class="line"><span style="color:#A6ACCD;">buf1[</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">] </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">12</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf1) </span><span style="color:#676E95;">// &lt;Buffer 68 0c 6c 6c 6f&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(buf2) </span><span style="color:#676E95;">// &lt;Buffer 68 65 6c 6c 6f&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>当传入的参数为一个 <code>Buffer</code> 的时候，会创建一个新的 <code>Buffer</code> 并复制上面的每一个成员。</p><p><code>Buffer</code> 为引用类型，一个 <code>Buffer</code> 复制了另一个 Buffer 的成员，当其中一个 Buffer 复制的成员有更改，另一个 Buffer 对应的成员不会跟着改变，说明传入<code>buffer</code>创建新的<code>Buffer</code>的时候是一个深拷贝的过程。</p><h2 id="buffer-的内存分配机制" tabindex="-1">Buffer 的内存分配机制 <a class="header-anchor" href="#buffer-的内存分配机制" aria-hidden="true">#</a></h2><p><strong>buffer 对应于 V8 堆内存之外的一块原始内存</strong></p><p><code>Buffer</code>是一个典型的<code>javascript</code>与<code>C++</code>结合的模块，与性能有关的用 C++来实现，<code>javascript</code> 负责衔接和提供接口。<code>Buffer</code>所占的内存不是<code>V8</code>堆内存，是独立于<code>V8</code>堆内存之外的内存，通过<code>C++</code>层面实现内存申请（可以说真正的内存是<code>C++</code>层面提供的）、<code>javascript</code> 分配内存（可以说<code>javascript</code>层面只是使用它）。<code>Buffer</code>在分配内存最终是使用<code>ArrayBuffer</code>对象作为载体。简单点而言， 就是<code>Buffer</code>模块使用<code>v8::ArrayBuffer</code>分配一片内存，通过<code>TypedArray</code>中的<code>v8::Uint8Array</code>来去写数据。</p><h4 id="内存分配的-8k-机制" tabindex="-1">内存分配的 8K 机制 <a class="header-anchor" href="#内存分配的-8k-机制" aria-hidden="true">#</a></h4><ul><li>分配小内存</li></ul><p>说道 Buffer 的内存分配就不得不说<code>Buffer</code>的<code>8KB</code>的问题，对应<code>buffer.js</code>源码里面的处理如下：</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">Buffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">poolSize </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1024</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">allocate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">size</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">size</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;"> ) </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">FastBuffer</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">size</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">Buffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">poolSize</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;&gt;&gt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> )</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">size</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">poolSize</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">poolOffset</span><span style="color:#F07178;">) </span><span style="color:#82AAFF;">createPool</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">allocPool</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">slice</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">poolOffset</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">poolOffset</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">size</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">poolOffset</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">size</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">alignPool</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">b</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createUnsafeBuffer</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">size</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>源码直接看来就是以 8KB 作为界限，如果写入的数据大于 8KB 一半的话直接则直接去分配内存，如果小于 4KB 的话则从当前分配池里面判断是否够空间放下当前存储的数据，如果不够则重新去申请 8KB 的内存空间，把数据存储到新申请的空间里面，如果足够写入则直接写入数据到内存空间里面，下图为其内存分配策略。</p><p><img src="`+e+`" alt="Buffer内存分配策略图"></p><p>看内存分配策略图，如果当前存储了 2KB 的数据，后面要存储 5KB 大小数据的时候分配池判断所需内存空间大于 4KB，则会去重新申请内存空间来存储 5KB 数据并且分配池的当前偏移指针也是指向新申请的内存空间，这时候就之前剩余的 6KB(8KB-2KB)内存空间就会被搁置。至于为什么会用<code>8KB</code>作为<code>存储单元</code>分配，为什么大于<code>8KB</code>按照大内存分配策略，在下面<code>Buffer</code>内存分配机制优点有说明。</p><ul><li>分配大内存</li></ul><p>还是看上面那张内存分配图，如果需要超过<code>8KB</code>的<code>Buffer</code>对象，将会直接分配一个<code>SlowBuffer</code>对象作为基础单元，这个基础单元将会被这个大<code>Buffer</code>对象独占。</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;">// Big buffer,just alloc one</span></span>
<span class="line"><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">parent </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SlowBuffer</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">length)</span></span>
<span class="line"><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">offset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里的<code>SlowBuffer</code>类实在<code>C++</code>中定义的，虽然引用 buffer 模块可以访问到它，但是不推荐直接操作它，而是用<code>Buffer</code>替代。这里内部<code>parent</code>属性指向的<code>SlowBuffer</code>对象来自<code>Node</code>自身<code>C++</code>中的定义，是<code>C++</code>层面的<code>Buffer</code>对象，所用内存不在<code>V8</code>的堆中</p><ul><li>内存分配的限制</li></ul><p>此外，<code>Buffer</code>单次的内存分配也有限制，而这个限制根据不同操作系统而不同，而这个限制可以看到<code>node_buffer.h</code>里面</p><div class="language-C line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">C</span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> kMaxLength </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#C792EA;">int32_t</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#C792EA;">intptr_t</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0x3fffffff</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0x7fffffff</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对于 32 位的操作系统单次可最大分配的内存为 1G，对于 64 位或者更高的为 2G。</p><h4 id="buffer-内存分配机制优点" tabindex="-1">buffer 内存分配机制优点 <a class="header-anchor" href="#buffer-内存分配机制优点" aria-hidden="true">#</a></h4><p><code>Buffer</code>真正的内存实在<code>Node</code>的<code>C++</code>层面提供的，<code>javascript</code>层面只是使用它。当进行小而频繁的<code>Buffer</code>操作时，采用的是<code>8KB</code>为一个单元的机制进行预先申请和事后分配，使得<code>Javascript</code>到操作系统之间不必有过多的内存申请方面的系统调用。对于大块的<code>Buffer</code>而言(大于<code>8KB</code>)，则直接使用<code>C++</code>层面提供的内存，则无需细腻的分配操作。</p><h2 id="buffer-与-stream" tabindex="-1">Buffer 与 stream <a class="header-anchor" href="#buffer-与-stream" aria-hidden="true">#</a></h2><h4 id="stream-的流动为什么要使用二进制-buffer" tabindex="-1">stream 的流动为什么要使用二进制 Buffer <a class="header-anchor" href="#stream-的流动为什么要使用二进制-buffer" aria-hidden="true">#</a></h4><p>根据最初代码的打印结果，<code>stream</code>中流动的数据就是<code>Buffer</code>类型，也就是<code>二进制</code>。</p><p><strong>原因一：</strong></p><p><code>node</code>官方使用二进制作为数据流动肯定是考虑过很多，比如在上一篇 <a href="./stream.html">想学 Node.js，stream 先有必要搞清楚</a>文章已经说过，stream 主要的设计目的——是为了优化<code>IO操作</code>（<code>文件IO</code>和<code>网络IO</code>），对应后端无论是<code>文件IO</code>还是<code>网络IO</code>，其中包含的数据格式都是未知的，有可能是字符串，音频，视频，网络包等等，即使就是字符串，它的编码格式也是未知的，可能<code>ASC编码</code>，也可能<code>utf-8</code>编码，对于这些未知的情况，还不如直接使用最通用的格式<code>二进制</code>.</p><p><strong>原因二：</strong></p><p><code>Buffer</code>对于<code>http</code>请求也会带来性能提升。</p><p>举一个例子：</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> http </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">require</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> fs </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">require</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> path </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">require</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> server </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> http</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createServer</span><span style="color:#A6ACCD;">(</span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fileName</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">__dirname</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">buffer-test.txt</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFile</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">fileName</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">end</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;">) </span><span style="color:#676E95;">// 测试1 ：直接返回二进制数据</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// res.end(data.toString())  // 测试2 ：返回字符串数据</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">server</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">listen</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">8000</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>将代码中的<code>buffer-test</code>文件大小增加到<code>50KB</code>左右，然后使用<code>ab</code>工具测试一下性能，你会发现无论是从<code>吞吐量</code>（Requests per second）还是连接时间上，返回二进制格式比返回字符串格式效率提高很多。为何字符串格式效率低？—— 因为网络请求的数据本来就是二进制格式传输，虽然代码中写的是 <code>response</code> 返回字符串，最终还得再转换为二进制进行传输，多了一步操作，效率当然低了。</p><h4 id="buffer-在-stream-数据流转充当的角色" tabindex="-1">Buffer 在 stream 数据流转充当的角色 <a class="header-anchor" href="#buffer-在-stream-数据流转充当的角色" aria-hidden="true">#</a></h4><p>我们可以把整个<code>流(stream)</code>和<code>Buffer</code>的配合过程看作<code>公交站</code>。在一些公交站，<code>公交车</code>在没有装满乘客前是不会发车的，或者在特定的时刻才会发车。当然，乘客也可能在不同的时间，人流量大小也会有所不同，有人多的时候，有人少的时候，<code>乘客</code>或<code>公交车站</code>都无法控制人流量。</p><p>不论何时，早到的乘客都必须等待，直到<code>公交车</code>接到指令可以发车。当乘客到站，发现<code>公交车</code>已经装满，或者已经开走，他就必须等待下一班车次。</p><p>总之，这里总会有一个等待的地方，这个<code>等待的区域</code>就是<code>Node.js</code>中的<code>Buffer</code>，<code>Node.js</code>不能控制数据什么时候传输过来，传输速度，就好像公交车站无法控制人流量一样。他只能决定什么时候发送数据(公交车发车)。如果时间还不到，那么<code>Node.js</code>就会把数据放入<code>Buffer</code>等待区域中，一个在 RAM 中的地址，直到把他们发送出去进行处理。</p><p><strong>注意点：</strong></p><p><code>Buffer</code>虽好也不要瞎用，<code>Buffer</code>与<code>String</code>两者都可以存储字符串类型的数据，但是，<code>String</code>与<code>Buffer</code>不同，在内存分配上面，<code>String</code>直接使用<code>v8堆存储</code>，不用经过<code>c++</code>堆外分配内存，并且<code>Google</code>也对<code>String</code>进行优化，在实际的拼接测速对比中，<code>String</code>比<code>Buffer</code>快。但是<code>Buffer</code>的出现是为了处理二进制以及其他非<code>Unicode</code>编码的数据，所以在处理<code>非utf8</code>数据的时候需要使用到<code>Buffer</code>来处理。</p>`,78),c=[o];function r(t,F,y,D,i,d){return a(),n("div",null,c)}const A=s(p,[["render",r]]);export{f as __pageData,A as default};
